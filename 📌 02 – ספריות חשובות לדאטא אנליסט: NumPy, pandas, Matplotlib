######################################################################
# ğŸ“Œ 02 â€“ ×¡×¤×¨×™×•×ª ×—×©×•×‘×•×ª ×œ×“××˜× ×× ×œ×™×¡×˜: NumPy, pandas, Matplotlib
#
# ××” ×™×© ×¤×”:
#  1) NumPy â€“ ×•×§×˜×•×¨×™×/××˜×¨×™×¦×•×ª ×•×¤×¢×•×œ×•×ª ××ª××˜×™×•×ª ××”×™×¨×•×ª
#  2) pandas â€“ ×˜×¢×™× ×ª × ×ª×•× ×™×, × ×™×§×•×™, GroupBy, Merge, Pivot, ×ª××¨×™×›×™×, rolling
#  3) Matplotlib â€“ ×’×¨×¤×™× ×‘×¡×™×¡×™×™× ×œ×”×¦×’×ª ×ª×•×‘× ×•×ª
#
# ×”×›×œ ×¢× ×”×¡×‘×¨×™× ×‘×¢×‘×¨×™×ª, ×“×•×’×××•×ª ×§×¦×¨×•×ª ×•×‘×¨×•×¨×•×ª.
######################################################################

# ---------------------------------------------------------------
# 1) NumPy â€“ ×—×™×©×•×‘ ××”×™×¨ ×¢×œ ××¢×¨×›×™×
# ---------------------------------------------------------------
import numpy as np

# ×™×¦×™×¨×ª ××¢×¨×š
arr = np.array([1, 2, 3, 4], dtype=np.float64)
print("arr:", arr, "dtype:", arr.dtype)

# ×¤×¢×•×œ×•×ª ×•×§×˜×•×¨×™×•×ª (×¨×¦×•×ª ××”×¨ ×××•×“ ×œ×¢×•××ª ×œ×•×œ××•×ª ×¤×™×™×ª×•×Ÿ):
print("arr + 10:", arr + 10)
print("arr * 2:", arr * 2)
print("mean:", arr.mean(), "std:", arr.std(), "sum:", arr.sum())

# ××˜×¨×™×¦×•×ª
A = np.array([[1, 2], [3, 4]])
B = np.eye(2)              # ××˜×¨×™×¦×ª ×™×—×™×“×” 2x2
print("A @ B:", A @ B)     # ×›×¤×œ ××˜×¨×™×¦×•×ª
print("transpose(A):", A.T)

# ××¡×›×•×ª (×¡×™× ×•×Ÿ ×¢×œ ×ª× ××™×)
mask = arr > 2
print("mask:", mask, "filtered:", arr[mask])

# ×˜×™×¤: ×œÖ¾pandas ×™×© ××™× ×˜×’×¨×¦×™×” ××¦×•×™× ×ª ×¢× NumPy (s.values ×•×›×•').


# ---------------------------------------------------------------
# 2) pandas â€“ ×˜×¢×™× ×”, × ×™×§×•×™, ×˜×¨× ×¡×¤×•×¨××¦×™×•×ª ×•× ×™×ª×•×—×™×
# ---------------------------------------------------------------
import pandas as pd

# × ×™×™×¦×¨ DataFrame ×§×˜×Ÿ ×œ×“×•×’××” (×‘××‘×—×Ÿ ××¤×©×¨ ×’× pd.read_csv("file.csv"))
orders = pd.DataFrame({
    "order_id":   [101, 102, 103, 104, 105, 106],
    "customer_id":[1,   1,   2,   2,   3,   1  ],
    "order_date": ["2025-07-01","2025-07-03","2025-07-03","2025-07-10","2025-07-11","2025-07-12"],
    "amount":     [120,  80,   50,  150,  300,  90]
})

customers = pd.DataFrame({
    "customer_id":[1, 2, 3],
    "name":       ["Dana","Avi","Chen"],
    "city":       ["Tel Aviv","Haifa","Jerusalem"]
})

print("\n=== orders.head() ===\n", orders.head())
print("\n=== customers ===\n", customers)

# ×”××¨×” ×œ×¢××•×“×ª ×ª××¨×™×š ×•×©×“×•×ª ×–××Ÿ
orders["order_date"] = pd.to_datetime(orders["order_date"])
orders["ym"] = orders["order_date"].dt.to_period("M")   # ×©× ×”-×—×•×“×© (Period)
orders["day"] = orders["order_date"].dt.date             # ×¨×§ ×ª××¨×™×š

# ×¡×™× ×•×Ÿ ×•××™×•×Ÿ
big = orders[orders["amount"] >= 100].sort_values("amount", ascending=False)
print("\n=== big orders (>=100) ===\n", big)

# ×‘×—×™×¨×ª ×¢××•×“×•×ª
subset = orders[["order_id","customer_id","amount"]]
print("\n=== subset ===\n", subset)

# GroupBy â€“ ×¡×›×•× ××›×™×¨×•×ª ×œ×œ×§×•×—
per_customer = (orders
                .groupby("customer_id", as_index=False)["amount"]
                .sum()
                .rename(columns={"amount":"total_amount"}))
print("\n=== per_customer (sum) ===\n", per_customer)

# ×××•×¦×¢ ××›×™×¨×•×ª ×œ×™×•×
daily = (orders
         .groupby("day", as_index=False)["amount"]
         .sum()
         .rename(columns={"amount":"daily_sales"}))
print("\n=== daily sales ===\n", daily)

# Merge â€“ ×¦×¨×£ ×¤×¨×˜×™ ×œ×§×•×—×•×ª ×œ××›×™×¨×•×ª
merged = per_customer.merge(customers, on="customer_id", how="left")
print("\n=== merged per_customer + customers ===\n", merged)

# Pivot / Pivot_table â€“ ××›×™×¨×•×ª ×œ×¤×™ ×—×•×“×© Ã— ×œ×§×•×—
monthly = (orders
           .groupby(["ym","customer_id"], as_index=False)["amount"].sum()
           .rename(columns={"amount":"sum_amount"}))
pv = monthly.pivot_table(index="ym", columns="customer_id",
                         values="sum_amount", aggfunc="sum")
print("\n=== pivot: ym Ã— customer_id (sum) ===\n", pv)

# Running total (cumsum) ×œ×œ×§×•×—
monthly_sorted = monthly.sort_values(["customer_id","ym"])
monthly_sorted["running"] = monthly_sorted.groupby("customer_id")["sum_amount"].cumsum()
print("\n=== running total per customer ===\n", monthly_sorted)

# Rolling window â€“ ×××•×¦×¢ × ×¢ ×œ-3 ×ª×§×•×¤×•×ª ×œ×›×œ ×œ×§×•×— (×–×§×•×§ ×œ××™×•×Ÿ)
monthly_sorted["rolling3"] = (monthly_sorted
                              .groupby("customer_id")["sum_amount"]
                              .rolling(3, min_periods=1)
                              .mean()
                              .reset_index(level=0, drop=True))
print("\n=== rolling 3 per customer ===\n", monthly_sorted)

# Handling missing values â€“ ××™×œ×•×™/×”×©×œ××”
s = pd.Series([1, None, 3, None, 5])
print("\n=== fillna ===\n", s.fillna(0))
print("\n=== ffill (×§×“×™××”) ===\n", s.ffill())
print("\n=== bfill (××—×•×¨×”) ===\n", s.bfill())

# ×–×™×”×•×™ ×›×¤×™×œ×•×™×•×ª ×•×”×¡×¨×”
dups = pd.DataFrame({"x":[1,1,2,3,3], "y":[10,10,20,30,30]})
print("\n=== dups ===\n", dups)
print("\n=== drop_duplicates ===\n", dups.drop_duplicates())

# Apply/Map â€“ ×”×¤×¢×œ×ª ×¤×•× ×§×¦×™×”
orders["size_bucket"] = orders["amount"].map(lambda v: "High" if v>=120 else ("Mid" if v>=80 else "Low"))
print("\n=== with size_bucket ===\n", orders[["order_id","amount","size_bucket"]])

# Join-keys ××¨×•×‘×™×
# (×“×•×’××” ×¡×§××˜×™×ª â€” ×× ×”×™×• ×œ× ×• ×›××” ××¤×ª×—×•×ª: df1.merge(df2, on=["key1","key2"], how="left"))

# ×©××™×¨×” ×œ×§×‘×¦×™×
# orders.to_csv("orders_out.csv", index=False)
# pv.to_excel("monthly_pivot.xlsx")


# ---------------------------------------------------------------
# 3) Matplotlib â€“ ×’×¨×¤×™× ×‘×¡×™×¡×™×™×
# ---------------------------------------------------------------
import matplotlib.pyplot as plt

# ×’×¨×£ ×§×• ×©×œ ××›×™×¨×•×ª ×™×•××™×•×ª
plt.figure()
plt.plot(daily["day"], daily["daily_sales"])
plt.title("Daily Sales")
plt.xlabel("Day")
plt.ylabel("Sales")
plt.xticks(rotation=45)
plt.tight_layout()
# plt.show()  # ×‘×˜×¡×˜×™×/×§×•× ×¡×•×œ ×¡×’×•×¨ ××¤×©×¨ ×œ×”×©××™×¨ ×›×ª×’×•×‘×”

# ×¢××•×“×•×ª â€“ ×¡×›×•× ××›×™×¨×•×ª ×œ×¤×™ ×œ×§×•×—
plt.figure()
plt.bar(per_customer["customer_id"].astype(str), per_customer["total_amount"])
plt.title("Total Sales by Customer")
plt.xlabel("Customer ID")
plt.ylabel("Total Sales")
plt.tight_layout()
# plt.show()

######################################################################
# ğŸ’¡ ×˜×™×¤×™× ××”×™×¨×™×:
# â€¢ pandas: ×¡×“×¨ × ×›×•×Ÿ â†’ ××™×•×Ÿ ×œ×¤× ×™ groupby().rolling()/cumsum() ×œ×¤×™ keys.
# â€¢ ×–××Ÿ: ×”××™×¨×• ×œ×¢×™×ª×•×ª (`to_datetime`) ××•×§×“×, ×•×”×©×ª××©×• ×‘Ö¾.dt (year/month/day/weekday).
# â€¢ Merge: ×ª××™×“ ×‘×“×•×§ ××ª ×’×•×“×œ ×”×ª×•×¦××” (shape) ×›×“×™ ×œ×•×•×“× ×©×œ× ×©×™×›×¤×œ×ª ×©×•×¨×•×ª ×‘×˜×¢×•×ª.
# â€¢ Pivot: ×× ×™×© NaN ××—×¨×™ pivot_table, ×©×§×•×œ .fillna(0) ×œ×”×¦×’×”.
# â€¢ Matplotlib: ×”×©×ª××© ×‘-tick rotation ×•×‘-tight_layout ×›×“×™ ×œ×× ×•×¢ ×—×™×ª×•×š ×˜×§×¡×˜.
# â€¢ NumPy: ××¡×›×•×ª (arr[cond]) ×•×”×¤×¢×œ×ª ×¤×¢×•×œ×•×ª ×•×§×˜×•×¨×™×•×ª ××”×™×¨×•×ª ×‘×”×¨×‘×” ××œ×•×œ××•×ª.
######################################################################
